# src/drv/8259A
## 文件说明

用于对外部io进行中断管理，主要是负责管理外部中断IO。

**工作原理**：8259A是专门为了对8085A和8086/8088进行中断控制而设计的芯片，它是可以用程序控制的中断控制器。单个的8259A能管理8级向量优先级中断。在不增加其他电路的情况下，最多可以级联成64级的向量优级中断系统。8259A有多种工作方式，能用于各种系统。各种工作方式的设定是在初始化时通过软件进行的。 在总线控制器的控制下，8259A芯片可以处于编程状态和操作状态，编程状态是CPU使用IN或OUT指令对8259A芯片进行初始化编程的状态。

一个外部中断请求信号通过中断请求线IRQ，传输到IMR（中断屏蔽寄存器），IMR根据所设定的中断屏蔽字（OCW1），决定是将其丢弃还是接受。如果可以接受，则8259A将IRR（中断请求暂存寄存器）中代表此IRQ的位置置1，以表示此IRQ有中断请求信号，并同时向CPU的INTR（中断请求）管脚发送一个信号。但CPU这时可能正在执行一条指令，因此CPU不会立即响应。而当这CPU正忙着执行某条指令时，还有可能有其余的IRQ线送来中断请求，这些请求都会接受IMR的挑选。如果没有被屏蔽，那么这些请求也会被放到IRR中，也即IRR中代表它们的IRQ的相应位会被置1。
当CPU执行完一条指令时后，会检查一下INTR管脚是否有信号。如果发现有信号，就会转到中断服务，此时，CPU会立即向8259A芯片的INTA（中断应答）管脚发送一个信号。当芯片收到此信号后，判优部件开始工作，它在IRR中，挑选优先级最高的中断，将中断请求送到ISR（中断服务寄存器），也即将ISR中代表此IRQ的位置一，并将IRR中相应位置零，表明此中断正在接受CPU的处理。同时，将它的编号写入中断向量寄存器IVR的低三位（IVR正是由ICW2所指定的，不知你是否还记得ICW2的最低三位在指定时都是0，而在这里，它们被利用了！）这时，CPU还会送来第二个INTA信号，当收到此信号后，芯片将IVR中的内容，也就是此中断的中断号送上通向CPU的数据线。
这个内容看起来仿佛十分复杂，但如果我们用一个很简单的比喻来解释就好理解了。CPU就相当于一个公司的老总，而8259A芯片就相当于这个老总的秘书。比如有很多人想见老总，但老总正在打电话，于是交由秘书先行接待。每个想见老总的人都需要把自己的名片交给秘书，秘书首先看看名片，有没有老总明确表示不愿见到的人，如果没有就把它放到一个盒子里面。这时老总的电话还没打完，但不停的有人递上名片求见老总，秘书就把符合要求的名片全放在盒子里了。老总打完电话了，探出头来问秘书：有人想见我吗？这时，秘书就从盒子里挑选一个级别最高的，并把他的名片交给老总。
这里需要理解的是中断屏蔽与优先级判定并不是一回事，如果被屏蔽了，那么参加判定的机会也都没了。在默认情况下，IRQ0的优先级最高，IRQ7最低。当然我们可以更改这个设定，这样在下面有详细描述。
当芯片把中断号送上通往CPU的数据线后，就会检测ICW4中的EOI是否被置位。如果EOI被置位表示需要自动清除中断请求信号，则芯片会自动将ISR中的相应位清零。如果EOI没有被置位，则需要中断处理程序向芯片发送EOI消息，芯片收到EOI消息后才会将ISR中的相应位清零。
这里的机关存在于这样一个地方。优先权判定是存在于8259A芯片中的，假如CPU正在处理IRQ1线来的中断，这时ISR中IRQ1所对应的位是置1的。这时来了一个IRQ2的中断请求，8259A会将其同ISR中的位进行比较，发现比它高的IRQ1所对应的位被置位，于是8259A会很遗憾的告诉IRQ2：你先在IRR中等等。而如果这时来的是IRQ0，芯片会马上让其进入ISR，即将ISR中的IRQ0所对应的位置位，并向CPU发送中断请求。这时由于IRQ1还在被CPU处理，所以ISR中IRQ1的位也还是被置位的，但由于IRQ0的优先级高，所以IRQ0的位也会被置位，并向CPU发送新的中断请求。此时ISR中IRQ0与IRQ1的位都是被置位的，这种情况在多重中断时常常发生，非常正常。
如果EOI被设为自动的，那么ISR中的位总是被清零的（在EOI被置位的情况下，8259A只要向CPU发送了中断号就会将ISR中的相应位清零），也就是如果有中断来，芯片就会马上再向CPU发出中断请求，即使CPU正在处理IRQ0的中断，CPU并不知道谁的优先级高，它只会简单的响应8259A送来的中断，因此，这种情况下低优先级的中断就可能会中断高优先级的中断服务程序。所以在PC中，我们总是将EOI位清零，而在中断服务程序结束的时候才发送EOI消息。

```
	       +----------+        +--------+
	       |      INTR|--------|  PIC   |---16 wires to devices
	       |       NMI|---     | 8259A  |
	       |   CPU    |        +--------+
	       |          | 
	       +----------+
```

NMI -- non-maskable interrupt -- signals hard failure

INTR maskable -- eflags IF (one bit!!)

​	IF 0 -- interrupts masked -- ie. ignored

​	IF 1 -- interrupts "unmasked" -- ie. not ignored

- 8259A.c

  实现初始化芯片中断，以及清空中断。

- include

  
  
- ##### 参考

  https://pdos.csail.mit.edu/6.828/2004/lec/l8.html

  https://baike.baidu.com/item/8259A/11048399?fr=aladdin#6

