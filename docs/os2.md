# 了解处理器

#### 什么是处理器

处理器就是电脑中最核心的部件，也就是CPU，英文名是central processing unit。处理器主要负责的是我们电脑中程序的运行以及包括对内存外存，外围IO设备的管理等。可以说一个处理器就是电脑最核心的部件，没有处理器也就没有电脑。处理器的发明可以说是代表人类最高智慧结晶。那么他的发明离不开一位伟大的数学家，阿兰图灵的贡献——图灵机。图灵机是一个计算机的理论模型，本质上是状态机；冯诺依曼体系是图灵机的实现，包括运算、控制、存储、输入、输出五个部分。

<img src="E:\workspace\gsoc_china\SimpleKernel\docs\images\turing machine.jpg" alt="turing machine" style="zoom:50%;" />

后来冯诺依曼根据图灵机理论的原理创造出冯诺依曼架构，这个架构师图灵机理论的工程实现，它定义了一个计算机所具有的组成部分，相对之前的计算机最大的创新在于程序和数据的存储，以此实现机器内部编程。

<img src="E:\workspace\gsoc_china\SimpleKernel\docs\images\von Artechture.jpg" alt="von Artechture" style="zoom:70%;" />

如图所示，主要包括运算器，控制器，存储器以及输入输出设备，而在CPU之中的主要包括运算器和控制器。每次CPU都要从存储器中取出数据和运行指令，然后在运算器的运算下得出结果，这一过程就是控制器的控制下进行的。



#### CPU 分类

CPU架构分类方式主要有两种，一种是根据微处理器指令集架构有以下几种架构：

**CISC**： 复杂指令集，英文名是CISC（Complex Instruction Set Computer的缩写），在CISC微处理器中，程序的各条指令是按顺序串行执行的，每条指令中的各个操作也是按顺序串行执行的。顺序执行的优点是控制简单，但计算机各部分的利用率不高，执行速度慢，但是每条指令可以处理的工作很丰富。

​      常见CISC微指令集主要集中在：AMD、Intel、VIA等IA-32、X86架构的CPU产品

**RISC：**精简指令集，英文全称是RISC（Reduced Instruction Set Computer的缩写），对指令数目和寻址方式都做了精简，使其实现更容易，指令并行执行程度更好，编译器的效率更高，执行性能较佳，但是要做复杂的事情，就需要多个指令来同时的完成。

​      常见RISC微指令集主要集中在：DECAlpha、ARC、ARM、AVR、MIPS、PA-RISC、IBM（PowerArchitecture(包括                       PowerPC)）、SUN（SPARC）

**EPIC：**显式并行指令集，英文全称是EPIC（Explicitly Parallel Instruction Computing的缩写），高效地并行处理而设计，能够同时处理多个指令或程序。并行处理可以增加每个处理器时钟周期内完成的有效工作数量，从而极大地提高应用性能。

​      常见EPIC微指令集主要集中在：Intel的IA-64架构的纯64位微处理器的Itanium/Itanium2

**VLIW：**超长指令集，英文全称是VLIW（Very Long Instruction Word的缩写），将多条指令放入一个指令字，有效的提高了CPU各个计算功能部件的利用效率，提高了程序的性能

​      常见EPIC微指令集主要集中在：Intel的IA-64架构的纯64位微处理器的Itanium



另外一种根据架构厂商出品分类为：

**X86架构**

X86架构是微处理器执行的计算机语言指令集，基于Intel 8086且向后兼容的中央处理器指令集架构，包括Intel 8086、80186、80286、80386以及80486，由于以“86”作为结尾，因此其架构被称为“x86”

**其类别包括有：**

​	**IA：**Intel（英特尔）处理器的服务器称之为IA（Intel Architecture）架构服务器

​			**IA-32：**英特尔32位体系架构，X86从16位到32位是在原有的架构基础上进行修改（Intel称之为IA-32），此外Intel把			x86-32称为IA-32

​	**x86-64**：

​				AMD64：x86架构的64位拓展，向后兼容于16位及32位的x86架构。x64于1999年由AMD设计，AMD首次公开64位集				以扩展给x86，称为“AMD64”，AMD64和Intel64基本上一致

​				Intel64：EM64T（Extended Memory 64 Technology）扩展64bit内存技术，本质上和AMD64一样都是IA-32的增强版				本。

​				IA-64：64位的英特尔架构，英特尔安腾架构（Intel Itanium architecture），使用在Itanium处理器家族上的64位指令集				架构，由英特尔公司与惠普公司共同开发。IA是Intel Architecture（英特尔架构）的缩写，64指64位系统。使用这种				架构的CPU，包括Itanium和Itanium 2。此架构与x86及x86-64并不相容，操作系统与软件需使用IA-64专用版本。

**ARM架构**

 ARM架构：[精简指令集](https://baike.baidu.com/item/精简指令集)机器RISC（Advanced [RISC](https://baike.baidu.com/item/RISC/62696) Machine，更早称作：Acorn RISC Machine），是一个32位精简指令集（RISC）[处理器](https://baike.baidu.com/item/处理器)架构，广泛地使用在许多[嵌入式](https://baike.baidu.com/item/嵌入式)系统设计。由于节能的特点，ARM处理器非常适用于移动通讯领域，符合其主要设计目标为低耗电的特性。ARM家族占了所有32位嵌入式处理器75%的比例，使它成为占全世界最多数的32位架构之一。ARM成立1991年英国剑桥，主要出售芯片设计技术授权。

**MIPS架构**

MIPS是世界上很流行的一种RISC处理器。MIPS的意思是“无内部互锁流水级的微处理器”(Microprocessor without interlocked piped stages)，其机制是尽量利用软件办法避免流水线中的数据相关问题。它最早是在80年代初期由斯坦福(Stanford)大学Hennessy教授领导的研究小组研制出来的。MIPS公司的R系列就是在此基础上开发的RISC工业产品的微处理器。这些系列产品为很多计算机公司采用构成各种工作站和计算机系统。

**PowerPC架构**

PowerPC 是一种精简指令集（RISC）架构的中央处理器（CPU），其基本的设计源自IBM（国际商用机器公司）的IBM PowerPC 601 微处理器POWER（Performance Optimized With Enhanced RISC；《IBM Connect 电子报》2007年8月号译为“增强RISC性能优化”）架构。二十世纪九十年代，IBM(国际商用机器公司)、Apple（苹果公司）和Motorola（摩托罗拉）公司开发PowerPC芯片成功，并制造出基于PowerPC的多处理器计算机。PowerPC架构的特点是可伸缩性好、方便灵活。
PowerPC 处理器有广泛的实现范围，包括从诸如 Power4 那样的高端服务器 CPU 到嵌入式 CPU 市场（任天堂 Gamecube 使用了 PowerPC）。PowerPC 处理器有非常强的嵌入式表现，因为它具有优异的性能、较低的能量损耗以及较低的散热量。除了象串行和以太网控制器那样的集成 I/O，该嵌入式处理器与“台式机”CPU 存在非常显著的区别。

**SPARC架构**

可扩充处理器架构”（Scalable Processor ARChitecture），是RISC[微处理器](https://baike.baidu.com/item/微处理器)架构之一。它最早于1985年由Sun电脑所设计，也是SPARC国际公司的注册商标之一。



#### 进入主题针对SimpleKernel介绍i386架构

前面是粗略介绍了下CPU的架构分类，本项目硬件环境目前只支持i386也就是x86架构32位开发。下面着重介绍下i386架构下的一些细节。

##### i386运行模式

一般CPU只有一种运行模式，能够支持多个程序在各自独立的内存空间中并发执行，且有用户特权级和内核特权级的区分，让一般应用不能破坏操作系统内核和执行特权指令。80386处理器有四种运行模式：实模式、保护模式、SMM模式和虚拟8086模式。主要对实模式、保护模式做一个简要介绍。

**实模式**：这是个人计算机早期的8086处理器采用的一种简单运行模式，当时微软的MS-DOS操作系统主要就是运行在8086的实模式下。80386加电启动后处于实模式运行状态，在这种状态下软件可访问的物理内存空间不能超过1MB，且无法发挥Intel 80386以上级别的32位CPU的4GB内存管理能力。实模式将整个物理内存看成分段的区域，程序代码和数据位于不同区域，操作系统和用户程序并没有区别对待，而且每一个指针都是指向实际的物理地址。这样用户程序的一个指针如果指向了操作系统区域或其他用户程序区域，并修改了内容，那么其后果就很可能是灾难性的。

**保护模式**：保护模式的一个主要目标是确保应用程序无法对操作系统进行破坏。实际上，80386就是通过在实模式下初始化控制寄存器（如GDTR，LDTR，IDTR与TR等管理寄存器）以及页表，然后再通过设置CR0寄存器使其中的保护模式使能位置位，从而进入到80386的保护模式。当80386工作在保护模式下的时候，其所有的32根地址线都可供寻址，物理寻址空间高达4GB。在保护模式下，支持内存分页机制，提供了对虚拟内存的良好支持。保护模式下80386支持多任务，还支持优先级机制，不同的程序可以运行在不同的特权级上。特权级一共分0～3四个级别，操作系统运行在最高的特权级0上，应用程序则运行在比较低的级别上；配合良好的检查机制后，既可以在任务间实现数据的安全共享也可以很好地隔离各个任务。

#### Intel 80386内存架构

地址是访问内存空间的索引。一般而言，内存地址有两个：一个是CPU通过总线访问物理内存用到的物理地址，一个是我们编写的应用程序所用到的逻辑地址（也有人称为虚拟地址）。比如如下C代码片段：

```
int boo=1;
int *foo=&a;
```

这里的boo是一个整型变量，foo变量是一个指向boo地址的整型指针变量，foo中储存的内容就是boo的逻辑地址。

80386是32位的处理器，即可以寻址的物理内存地址空间为2\^32=4G字节。为更好理解面向80386处理器的操作系统，需要用到三个地址空间的概念：**物理地址**、**线性地址**和**逻辑地址**（即虚拟地址）。物理内存地址空间是处理器提交到总线上用于访问计算机系统中的内存和外设的最终地址。一个计算机系统中只有一个物理地址空间。线性地址空间是80386处理器通过段（Segment）机制控制下的形成的地址空间。在操作系统的管理下，每个运行的应用程序有相对独立的一个或多个内存空间段，每个段有各自的起始地址和长度属性，大小不固定，这样可让多个运行的应用程序之间相互隔离，实现对地址空间的保护。

在操作系统完成对80386处理器段机制的初始化和配置（主要是需要操作系统通过特定的指令和操作建立全局描述符表(gdt)，完成虚拟地址与线性地址的映射关系）后，80386处理器的段管理功能单元负责把虚拟地址转换成线性地址，在没有下面介绍的页机制启动的情况下，这个线性地址就是物理地址。

相对而言，段机制对大量应用程序分散地使用大内存的支持能力较弱。所以Intel公司又加入了页机制，每个页的大小是固定的（一般为4KB），也可完成对内存单元的安全保护，隔离，且可有效支持大量应用程序分散地使用大内存的情况。

在操作系统完成对80386处理器页机制的初始化和配置（主要是需要操作系统通过特定的指令和操作建立页表，完成虚拟地址与线性地址的映射关系）后，应用程序看到的逻辑地址先被处理器中的段管理功能单元转换为线性地址，然后再通过80386处理器中的页管理功能单元把线性地址转换成物理地址。

> 页机制和段机制有一定程度的功能重复，但Intel公司为了向下兼容等目标，使得这两者一直共存。

上述三种地址的关系如下：

- 分段机制启动、分页机制未启动：逻辑地址--->***段机制处理\***--->线性地址=物理地址
- 分段机制和分页机制都启动：逻辑地址--->***段机制处理\***--->线性地址--->***页机制处理\***--->物理地址



#### Intel 80386寄存器

这里假定读者对80386 CPU有一定的了解，所以只作简单介绍。80386的寄存器可以分为8组：通用寄存器，段寄存器，指令指针寄存器，标志寄存器，系统地址寄存器，控制寄存器，调试寄存器，测试寄存器，它们的宽度都是32位。一般程序员看到的寄存器包括通用寄存器，段寄存器，指令指针寄存器，标志寄存器。

General Register(通用寄存器)：EAX/EBX/ECX/EDX/ESI/EDI/ESP/EBP这些寄存器的低16位就是8086的 AX/BX/CX/DX/SI/DI/SP/BP，对于AX,BX,CX,DX这四个寄存器来讲,可以单独存取它们的高8位和低8位 (AH,AL,BH,BL,CH,CL,DH,DL)。它们的含义如下:

```
EAX：累加器
EBX：基址寄存器
ECX：计数器
EDX：数据寄存器
ESI：源地址指针寄存器
EDI：目的地址指针寄存器
EBP：基址指针寄存器
ESP：堆栈指针寄存器
```

![image003](E:\workspace\gsoc_china\SimpleKernel\docs\images\image003.png)

Segment Register(段寄存器，也称 Segment Selector，段选择符，段选择子)：除了8086的4个段外(CS,DS,ES,SS)，80386还增加了两个段FS，GS,这些段寄存器都是16位的，用于不同属性内存段的寻址，它们的含义如下：

```
CS：代码段(Code Segment)
DS：数据段(Data Segment)
ES：附加数据段(Extra Segment)
SS：堆栈段(Stack Segment)
FS：附加段
GS: 附加段
```

![image004](E:\workspace\gsoc_china\SimpleKernel\docs\images\image004.png)

Instruction Pointer(指令指针寄存器)：EIP的低16位就是8086的IP，它存储的是下一条要执行指令的内存地址，在分段地址转换中，表示指令的段内偏移地址。

![image005](E:\workspace\gsoc_china\SimpleKernel\docs\images\image005.png)

Flag Register(标志寄存器)：EFLAGS,和8086的16位标志寄存器相比，增加了4个控制位，这20位控制/标志位的位置如下图所示：

<img src="E:\workspace\gsoc_china\SimpleKernel\docs\images\image006.png" alt="image006"  />

相关的控制/标志位含义是：

```
CF(Carry Flag)：进位标志位；
PF(Parity Flag)：奇偶标志位；
AF(Assistant Flag)：辅助进位标志位；
ZF(Zero Flag)：零标志位；
SF(Singal Flag)：符号标志位；
IF(Interrupt Flag)：中断允许标志位,由CLI，STI两条指令来控制；设置IF位使CPU可识别外部（可屏蔽）中断请求，复位IF位则禁止中断，IF位对不可屏蔽外部中断和故障中断的识别没有任何作用；
DF(Direction Flag)：向量标志位，由CLD，STD两条指令来控制；
OF(Overflow Flag)：溢出标志位；
IOPL(I/O Privilege Level)：I/O特权级字段，它的宽度为2位,它指定了I/O指令的特权级。如果当前的特权级别在数值上小于或等于IOPL，那么I/O指令可执行。否则，将发生一个保护性故障中断；
NT(Nested Task)：控制中断返回指令IRET，它宽度为1位。若NT=0，则用堆栈中保存的值恢复EFLAGS，CS和EIP从而实现中断返回；若NT=1，则通过任务切换实现中断返回。在ucore中，设置NT为0。
```

还有一些应用程序无法访问的控制寄存器，如CR0,CR2，CR3...，将在后续章节逐一讲解。



参考：

[https://baike.baidu.com/item/IA32%E6%9E%B6%E6%9E%84/4189056?fr=aladdin](https://baike.baidu.com/item/IA32架构/4189056?fr=aladdin)

https://www.cnblogs.com/shao-ye/p/10742716.html

https://chyyuu.gitbooks.io/ucore_os_docs/content/lab0/lab0_2_5_1_intel_80386_modes.html









