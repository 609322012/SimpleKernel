# 中断管理

**中断的定义：**

中断是什么？这里所说的是发生在计算机世界里的中断。由于 CPU 获知了计算机中发生的某些事， CPU 暂停正在执行的程序，转而去执行处理该事件的程序，当这段程序执行完毕后， CPU 继续执行刚才的程序。整个过程称为中断处理，也称为中断。  通俗地说，中断的意思是打断正在做的事，  就比如说正在考试的过程中突然想上厕所，这就是打断了考试这一动作，切换到了上厕所。这里就有一个优先级的概念，也就是上厕所的优先级高于考试的优先级。对于CPU也是一样的，正是有多个优先级，才能让中断可以更好的进行处理。正式因为中断的存在能够让程序并行运行，实现更高效率的运行，充分利用CPU的运算资源。

把中断按事件来源分类，来自 CPU 外部的中断就称为外部中断，来自 CPU 内部的中断称为内部中断。其实还可以再细分，外部中断按是否导致宕机来划分，可分为可屏蔽中断和不可屏蔽中断两种，而内部中断按中断是否正常来划分，可分为软中断和异常。  

**外部中断**：来自于CPU外部的中断，外部的中断源必须是某个硬件。所以外部中断又称硬件中断。

**内部中断**：可分为软中断和异常。

1. **软中断**，就是由软件主动发起的中断，因为它来自于软件，所以称之为软中断。由于该中断是软件运行中主动发起的，所以它是主观上的，井不是客观上的某种内部错误。  
2. **异常**是另一种内部中断，是指令执行期间 CPU 内部产生的错误引起的。

异常和不可屏蔽中断的中断向量号是由 CPU 自动提供的，而来自外部设备的可屏蔽中断号是由中断代理提供的（咱们这里的中断代理是 8259A ），软中断是由软件提供的。  

操作系统是中断驱动的，中断发生后会执行相应的中断处理程序，我们希望 CPU 中断响应的时间越短越好，这样便能响应更多设备的中断。但是中断处理程序还是需要完整执行的，不能光为了提高中断响应效率而只执行部分中断处理程序 。 于是，把中断处理程序分为上半部和下半部两部分，把中断处理程序中需要立即执行的部分（分分钟不能耽误的部分）划分到上半部，这部分是要限时执行的，所以通常情况下只完成中断应答或硬件复位等重要紧迫的工作。而中断处理程序中那些不紧急的部分则被推迟到下半部中去完成。由于中断处理程序的上半部是刻不容缓要执行的，所以上半部是在关中断不被打扰的情况下执行的。当上半部执行完成后就把中断打开了，下半部也属于中断处理程序，所以中断处理程序下半部则是在开中断的情况下执行的，如果有新的中断发生，原来这个旧中断的下半部就会被换下 CPU，先执行新的中断处理程序的上半部，等待线程调度机制为旧中断处理程序择一 日期（就是指调度算法认为的某个恰当时机）后，再调度其上 CPU 完成其下半部的执行。  

**可编程中断控制器8259A**:

8259A 的作用是负责所有来自外设的中断，其中就包括来自时钟的中断，以后我们要通过它完成进程调度。  

为了让 CPU 获得每个外部设备的中断信号，最好的方式是在 CPU 中为每一个外设准备一个引脚接收中断，但这是不可能的，计算机中挂了很多外部设备，而且外设数量是没有上限的，无论 CPU 中准备多少引脚都不够用，况且，引脚越多，体积越大，我们还嫌目前 CPU 的体积大呢。  

可屏蔽中断是通过INTR 信号线进入 CPU 的，一般可独立运行的外部设备，如打印机、声卡等，其发出的中断都是可屏蔽中断，都共享这一根则INTR 信号线通知 CPU。可以想想看，任务是串行在 CPU 上执行的， CPU 每次只能执行一个任务，如果同时有多个外设发出中断，而 CPU 只能先处理一个，它到底先响应哪个呢？还有，为了不使这些中断丢失，是否要为它们单独维护一个中断队列？这些问题如果让CPU 来做的话，似乎有些大材小用了，不仅要占用 CPU 时间，而且还要占用内存来存储中断队列，所以，干脆请个专人来做这事吧，这个专业人士就是中断代理，由它负责对所有中断仲裁，决定哪个中断优先被 CPU受理。这有点像大臣和皇帝的关系，低阶官员写的奏折只能先交给大臣，由大臣决定是否要呈给皇帝过目。  

中断代理有很多种，我们这里采用的是较流行的中断代理： Intel 8259A 芯片，就是本节所说的可编程中断控制器（ PIC) 8259A 。  

8259A 用于管理和控制可屏蔽中断，它表现在屏蔽外设中断，对它们实行优先级判决，向 CPU 提供中断向量号等功能。而它称为可编程的原因，就是可以通过编程的方式来设置以上的功能。  

Intel 处理器共支持 256 个中断，但 8259A 只可以管理 8 个中断，不知道 Intel 这是要闹哪样，所以它为了多支持一些中断设备，提供了另 一个解决方案，将多个 8259A 组合，官方术语就是级联。有了级联这种组合后，每一个 8259A 就被称为 l 片 。若采用级联方式，即多片 8259A 芯片串连在一起，最多可级联 9 个，也就是最多支持 64 个中断 。 n 片 8259A 通过级联可支持 7n+l 个中断源，级联时只能有一片 8259A为主片 master，其余的均为从片 slave。来自从片的中断只能传递给主片，再由主片向上传递给 CPU，也就是说只有主片才会向 CPU 发送 INT 中断信号。  	

外部设备和 8259A 芯片是独立的，它们也得通过信号线连接到 8259A，主板电路上己经实现了这些，咱们只要把外设往主板上一插，这些设备自动就和 8259A 连接上了 。 这些设备在发中断的时候都以为是直接发给了 CPU ，它们并不知道中间还隔着个中断代理 ， 8259A 在收到了中断后，对中断判优，将优先级最高的中断转发给 CPU 处理 。

<img src=".\images\8259A.jpg" alt="8259A" style="zoom:67%;" />

**INT**: 8259A 选出优先级最高的中断请求后，发信号通知 CPU。  

**INTA**: INT Acknowledge，中断响应信号 。 位于 8259A 中的 INTA 接收来自 CPU 的INTA 接口的中断响应信号。  

**IMR**: Interrupt Mask Register，中断屏蔽寄存器，宽度是 8 位，用来屏蔽某个外设的中断 。  

**IRR**: Interrupt Request Register，中断请求寄存器，宽度是 8 位。它的作用是接受经过 IMR 寄存器过滤后的中断信号并锁存，此寄存器中全是等待处理的中断，“相当于” 5259A 维护的未处理中断信号队列 。  

**PR**: Priority Resolver，优先级仲裁器 。 当有多个中断同时发生，或当有新的中断请求进来时，将它与当前正在处理的中断进行比较，找出优先级更高的中断。  

**ISR**: In-Service Register，中断服务寄存器，宽度是 8 位。当某个中断正在被处理时，保存在此寄存器中 。  

![8259a inter](E:\workspace\gsoc_china\SimpleKernel\docs\images\8259a inter.png)

在“有图有真相”之后，咱们看看当 8259A 收到一个中断后会发生什么呢？现在可以介绍 8259A 的工作流程了。
当某个外设发出一个中断信号时，由于主板上已经将信号通路指向了 8259A 芯片的某个 IRQ 接口，所以该中断信号最终被送入了 8259A 。 8259A 首先检查肌1R 寄存器中是否已经屏蔽了来自该 IRQ 接口的中断信号。 IMR 寄存器中的位，为 1 ，则表示中断屏蔽，为 0，则表示中断放行。如果该 IRQ 对应的相应位己经被置 1 ，即表示来自该 IRQ 接口上的中断已经被屏蔽了，则将该中断信号丢弃，否则，将其送入 IRR寄存器，将该 IRQ 接口所在 IRR 寄存器中对应的 BIT 置 1 。 IRR 寄存器的作用“相当于”待处理中断队列。在某个恰当时机，优先级仲裁器 PR 会从 IRR 寄存器中挑选一个优先级最大的中断，此处的优先级决判很简单，就是 IRQ 接口号越低，优先级越大，所以 IRQO 优先级最大。之后， 8259A 会在控制电路中，通过 INT 接口向 CPU 发送时TR 信号。信号被送入了 CPU 的时TR 接口后，这样 CPU 便知道有新的中断到来了，又有活干了，于是 CPU 将手里的指令执行完后，马上通过自己的时TA 接口向 8259A 的 INTA接口回复一个中断响应信号，表示现在 CPU 我己准备好啦， 8259A 你可以继续后面的工作。 8259A 在收到这个信号后，立即将刚才选出来的优先级最大的中断在 ISR 寄存器中对应的 BIT 置 l ，此寄存器表示当前正在处理的中断，同时要将该中断从“待处理中断队列”寄存器 IRR 中去掉，也就是在 IRR 中将该中断对应的 BIT 置 0。之后， CPU 将再次发送 INTA 信号给 8259A，这一次是想获取中断对应的中断向量号，就是我们前面所说的 0～255 的“整数”。由于大部分情况下 8259A 的起始中断向量号并不是 0 （起始中断向量号被修改，原因后面会说），所以用起始中断向量号＋IRQ 接口号便是该设备的中断向量号，由此可见，外部设备虽然会发中断信号，但它并不知道还有中断向量号这回事，不知道自己会被中断代理（如 8259A）分配一个这样的整数。随后， 8259A 将此中断向量号通过系统数据总线发送给 CPU 。 CPU 从数据总线上拿到该中断向量号后，用它做中断向量表或中断描述符表中的索引，找到相应的中断处理程序井去执行。  



在开机之后的实模式下， BIOS 也对其进行配置， 8259A 的 IRQO～7 己经被 BIOS 分配了 Ox8～Oxf 的中断向量号。  中断向量号是逻辑上的东西，它在物理上是 8259A 上的 IRQ 接口号。 8259A 上 IRQ 号的排列顺序是固定的，但其对应的中断向量号是不固定的，这其实是一种由硬件到软件的映射，通过设置 8259A，可以将 IRQ 接口映射到不同的中断向量号。  

**Reference：**

操作系统真像还原 